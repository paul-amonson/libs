// Copyright (C) 2018-2019 Paul Amonson
//
// SPDX-License-Identifier: Apache-2.0
//

apply plugin: 'idea'

def honorScanningRules = true

def gitVersionString = { ->
    def stdout = new ByteArrayOutputStream()
    exec {
        commandLine 'git', 'describe', '--tags'
        standardOutput = stdout
    }
    return stdout.toString().trim()
}

println("*** Building version: " + gitVersionString() + "\n")

allprojects {
    apply plugin: 'java'
    apply plugin: 'jacoco'
    apply plugin: 'pmd'

    version = gitVersionString()
    repositories {
        mavenCentral()
    }
}

subprojects {
    targetCompatibility = 11
    sourceCompatibility = 11

    dependencies {
        testCompile 'junit:junit:4.12+'
    }

    clean {
        delete += "${projectDir}/out"
    }

    javadoc {
        options.addBooleanOption('html5', true)
        doLast {
            copy {
                from(javadoc.outputs)
                into "${rootProject.buildDir}/docs/documentation/${project.name}"
            }
            copy {
                from(file("${rootProject.projectDir}/html_src/stylesheet.css"))
                into "${rootProject.buildDir}/docs/documentation"
            }
            new File((String)"${rootProject.buildDir}/docs/documentation").mkdirs()
            new File((String)"${rootProject.buildDir}/docs/documentation/index.html").text = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>libs API Java Documentation</title>
    <link rel="stylesheet" type="text/css" href="/stylesheet.css" title="Style">
</head>
<body style="background-color:#dee3e9;">
<h1 style="text-indent:20px"><a>${rootProject.name}</a> API Java Documentation (${rootProject.version})</h1>
<ul>
    <li>Package: <a href="crypto/index.html">crypto</a></li>
    <li>Package: <a href="logger/index.html">logger</a></li>
    <li>Package: <a href="prop_store/index.html">prop_store</a></li>
    <li>Package: <a href="xdg/index.html">xdg</a></li>
</ul>
</body>
</html>
"""
            new File((String)"${rootProject.buildDir}/docs/reports").mkdirs()
            new File((String)"${rootProject.buildDir}/docs/reports/index.html").text = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>libs Reports for Last Build</title>
    <link rel="stylesheet" type="text/css" href="/stylesheet.css" title="Style">
</head>
<body style="background-color:#dee3e9;">
<h1>Build Reports for <a href="https://github.com/paul-amonson/libs">${rootProject.name}</a>
Build: <i>${rootProject.version}</i></h1>
<h2 style="text-indent:20px">Test Reports</h2>
<ul>
    <li>Tests: <a href="test/crypto/index.html">crypto</a></li>
    <li>Tests: <a href="test/logger/index.html">logger</a></li>
    <li>Tests: <a href="test/prop_store/index.html">prop_store</a></li>
    <li>Tests: <a href="test/xdg/index.html">xdg</a></li>
</ul>
<h2 style="text-indent:20px">Jacoco Coverage Reports</h2>
<ul>
    <li>Coverage: <a href="jacoco/crypto/index.html">crypto</a></li>
    <li>Coverage: <a href="jacoco/logger/index.html">logger</a></li>
    <li>Coverage: <a href="jacoco/prop_store/index.html">prop_store</a></li>
    <li>Coverage: <a href="jacoco/xdg/index.html">xdg</a></li>
</ul>
<h2 style="text-indent:20px">PMD Static Analysis Reports</h2>
<ul>
    <li>Analysis: <a href="pmd/crypto.html">crypto</a></li>
    <li>Analysis: <a href="pmd/logger.html">logger</a></li>
    <li>Analysis: <a href="pmd/prop_store.html">prop_store</a></li>
    <li>Analysis: <a href="pmd/xdg.html">xdg</a></li>
</ul>
</body>
</html>
"""
        }
    }

    check {
        finalizedBy(javadoc)
    }

    compileJava {
        options.compilerArgs << '-Werror'
        options.compilerArgs << '-Xlint:all,-processing,-path'
        options.compilerArgs << '-XDignore.symbol.file=true'
        options.fork = true
        options.forkOptions.executable = 'javac'
    }

    test {
        reports {
            html.destination file("${rootProject.buildDir}/docs/reports/test/${project.name}")
            junitXml.destination file("${rootProject.buildDir}/tests/${project.name}")
        }
        finalizedBy(jacocoTestReport, pmdMain)
    }

    jar {
        from {
            configurations.compile.collect { it.isDirectory() ? it : zipTree(it) }
        }
    }

    pmdTest.enabled = false
    pmdMain {
        group = "Reporting"
        consoleOutput = true
        rulePriority = 2
        ignoreFailures = !honorScanningRules
        reports {
            xml.enabled = true
            xml.destination = file("${rootProject.buildDir}/pmd/${project.name}.xml")
            html.enabled = true
            html.destination = file("${rootProject.buildDir}/docs/reports/pmd/${project.name}.html")
        }
    }

    jacocoTestReport {
        group = "Reporting"
        reports {
            xml.enabled = true
            csv.enabled = false
            html.destination file("${rootProject.buildDir}/docs/reports/jacoco/${project.name}")
            xml.destination file("${rootProject.buildDir}/jacoco/${project.name}.xml")
        }
        finalizedBy(jacocoTestCoverageVerification)
    }

    jacocoTestCoverageVerification {
        violationRules {
            rule {
                element = 'PACKAGE'
                enabled = honorScanningRules
                limit {
                    counter = 'METHOD'
                    minimum = 0.90
                }
            }
            rule {
                element = 'PACKAGE'
                enabled = honorScanningRules
                limit {
                    counter = 'BRANCH'
                    minimum = 0.70
                }
            }
        }
    }
}

project(':logger') {
    group = 'com.amonson'
    dependencies {
    }
}

project(':xdg') {
    group = 'com.amonson'
    dependencies {
    }
}

project(':prop_store') {
    group = 'com.amonson'
    dependencies {
        compile group: 'com.github.cliftonlabs', name: 'json-simple', version: '3.0.2+'
        compile group: 'org.yaml', name: 'snakeyaml', version: '1.21+'
    }
}

project(':crypto') {
    group = 'com.amonson'
    dependencies {
        compile project(':prop_store')
    }
}

project(':factory') {
    group = 'com.amonson'
    dependencies {
        compile project(':logger')
    }
}

task fatJar(type: Jar, dependsOn: subprojects.jar) {
    subprojects.each { subproject ->
        from subproject.configurations.archives.allArtifacts.files.collect {
            zipTree(it)
        }
    }
}
check.finalizedBy(fatJar)
